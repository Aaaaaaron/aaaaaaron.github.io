<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://aaaaaaron.github.io').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: true,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="http:&#x2F;&#x2F;lvheyang.com&#x2F;wp-content&#x2F;uploads&#x2F;2016&#x2F;02&#x2F;%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8EParquet%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E4%BA%AB.pdf     recommended to set the parquet block s">
<meta property="og:type" content="article">
<meta property="og:title" content="Parquet 乱弹">
<meta property="og:url" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/index.html">
<meta property="og:site_name" content="Jiatao Tao&#39;s blog">
<meta property="og:description" content="http:&#x2F;&#x2F;lvheyang.com&#x2F;wp-content&#x2F;uploads&#x2F;2016&#x2F;02&#x2F;%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8EParquet%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E4%BA%AB.pdf     recommended to set the parquet block s">
<meta property="og:locale">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509164025.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509165611.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509170805.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509182510.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528104542.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528104910.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105205.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105231.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105342.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105441.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103634.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103701.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528110659.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528110909.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528111155.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103907.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103951.png">
<meta property="og:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528104202.png">
<meta property="article:published_time" content="2019-05-09T08:30:34.000Z">
<meta property="article:modified_time" content="2021-05-08T03:13:53.923Z">
<meta property="article:author" content="Jiatao Tao">
<meta property="article:tag" content="Parquet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509164025.png">

<link rel="canonical" href="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Parquet 乱弹 | Jiatao Tao's blog</title><meta name="robots" content="noindex">
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiatao Tao's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">λ</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://aaaaaaron.github.io/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="Jiatao Tao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiatao Tao's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          Parquet 乱弹
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-09 16:30:34" itemprop="dateCreated datePublished" datetime="2019-05-09T16:30:34+08:00">2019-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-08 11:13:53" itemprop="dateModified" datetime="2021-05-08T11:13:53+08:00">2021-05-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a target="_blank" rel="noopener" href="http://lvheyang.com/wp-content/uploads/2016/02/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8EParquet%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E4%BA%AB.pdf">http://lvheyang.com/wp-content/uploads/2016/02/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8EParquet%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E4%BA%AB.pdf</a></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509164025.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509165611.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509170805.png"></p>
<hr>
<p>recommended to set the parquet block size to match the MFS chunk size for optimal performance.  The default MFS chunk size is 256 MB. </p>
<p>A typical Hadoop job is IO bound, not CPU bound, so a light and fast compression codec will actually improve performance. </p>
<p>For MapReduce, if you need your compressed data to be splittable, BZip2 and LZO formats can be split. Snappy and GZip blocks are not splittable, but files with Snappy blocks inside a container file format such as SequenceFile or Avro can be split. </p>
<p>Compress Parquet files with Snappy they are indeed splittable, Property parquet.block.size defines Parquet file block size (row group size) and normally would be the same as HDFS block size. Snappy would compress Parquet row groups making Parquet file splittable.</p>
<p>The consequence of storing the metadata in the footer is that reading a Parquet file requires an initial seek to the end of the file (minus 8 bytes) to read the footer metadata length, then a second seek backward by that length to read the footer metadata. Unlike sequence files and Avro datafiles, where the metadata is stored in the header and sync markers are used to separate blocks, Parquet files don’t need sync markers since the block boundaries are stored in the footer metadata. (This is possible because the metadata is written after all the blocks have been written, so the writer can retain the block boundary positions in memory until the file is closed.) Therefore, Parquet files are splittable, since the blocks can be located after reading the footer and can then be processed in parallel (by MapReduce, for example).</p>
<hr>
<p>parquet tool</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">usage: parquet-tools cat [option...] &lt;input&gt;</span><br><span class="line">usage: parquet-tools head [option...] &lt;input&gt;</span><br><span class="line">usage: parquet-tools schema [option...] &lt;input&gt;</span><br><span class="line">usage: parquet-tools meta [option...] &lt;input&gt;</span><br><span class="line">usage: parquet-tools dump [option...] &lt;input&gt;</span><br><span class="line">usage: parquet-tools merge [option...] &lt;input&gt; [&lt;input&gt; ...] &lt;output&gt;</span><br></pre></td></tr></table></figure>

<hr>
<p>for spark:<br><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190509182510.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testParquetRead</span><span class="params">(<span class="keyword">double</span>[] data, CompressionCodecName compress)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">    List&lt;Type&gt; fields = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        fields.add(<span class="keyword">new</span> PrimitiveType(Type.Repetition.REQUIRED, PrimitiveType.PrimitiveTypeName.DOUBLE, <span class="string">&quot;f&quot;</span> + i));</span><br><span class="line">    &#125;</span><br><span class="line">    MessageType schema = <span class="keyword">new</span> MessageType(<span class="string">&quot;ori&quot;</span>, fields);</span><br><span class="line"></span><br><span class="line">    writeFile(conf, schema, data, compress);</span><br><span class="line">    testRowGroupRead(conf, schema);</span><br><span class="line">    testSimpleRead(conf, data.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeFile</span><span class="params">(Configuration conf, MessageType schema, <span class="keyword">double</span>[] data, CompressionCodecName compress)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    GroupWriteSupport.setSchema(schema, conf);</span><br><span class="line">    ParquetWriter&lt;Group&gt; writer = <span class="keyword">new</span> ParquetWriter&lt;&gt;(path, <span class="keyword">new</span> GroupWriteSupport(), compress, <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">            <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">1048576</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, PARQUET_2_0, conf);</span><br><span class="line"></span><br><span class="line">    SimpleGroupFactory simpleGroupFactory = <span class="keyword">new</span> SimpleGroupFactory(schema);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">double</span> v : data) &#123;</span><br><span class="line">        writer.write(simpleGroupFactory.newGroup().append(<span class="string">&quot;f0&quot;</span>, v).append(<span class="string">&quot;f1&quot;</span>, v).append(<span class="string">&quot;f2&quot;</span>, v));</span><br><span class="line">    &#125;</span><br><span class="line">    writer.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testRowGroupRead</span><span class="params">(Configuration conf, MessageType messageType)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ParquetMetadata footer = ParquetFileReader.readFooter(conf, path, ParquetMetadataConverter.NO_FILTER);</span><br><span class="line">    ParquetFileReader parquetFileReader = <span class="keyword">new</span> ParquetFileReader(conf, footer.getFileMetaData(), path,</span><br><span class="line">            footer.getBlocks(), messageType.getColumns());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> totalRowCount = <span class="number">0</span>;</span><br><span class="line">    PageReadStore pageReadStore = parquetFileReader.readNextRowGroup();</span><br><span class="line">    <span class="keyword">while</span> (pageReadStore != <span class="keyword">null</span>) &#123;</span><br><span class="line">        totalRowCount += pageReadStore.getRowCount();</span><br><span class="line">        <span class="keyword">for</span> (ColumnDescriptor columnDescriptor : footer.getFileMetaData().getSchema().getColumns()) &#123;</span><br><span class="line">            pageReadStore.getPageReader(columnDescriptor).readPage();</span><br><span class="line">        &#125;</span><br><span class="line">        pageReadStore = parquetFileReader.readNextRowGroup();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;Row Group read style take:&quot;</span> + (System.currentTimeMillis() - t));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testSimpleRead</span><span class="params">(Configuration conf, <span class="keyword">int</span> n)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ParquetReader&lt;Group&gt; reader = ParquetReader.builder(<span class="keyword">new</span> GroupReadSupport(), path).withConf(conf).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        Group group = reader.read();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">            group.getDouble(<span class="string">&quot;m&quot;</span> + j, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;Simple read take:&quot;</span> + (System.currentTimeMillis() - t));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="page"><a href="#page" class="headerlink" title="page"></a>page</h3><p>read : int rowGroup, int column, long offset</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ParquetMetadata parquetMetadata = ParquetFileReader.readFooter(config, path, ParquetMetadataConverter.NO_FILTER)</span><br><span class="line">BlockMetaData blockMetaData = parquetMetadata.getBlocks().get(rowGroup);</span><br><span class="line">ColumnChunkMetaData columnChunkMetaData = blockMetaData.getColumns().get(column);</span><br><span class="line">ColumnDescriptor columnDescriptor = parquetMetadata.getFileMetaData().getSchema().getColumns().get(column)</span><br><span class="line">inputStream.seek(offset);</span><br><span class="line">PageHeader pageHeader = Util.readPageHeader(inputStream);</span><br><span class="line">DataPageHeader dataPageHeader = pageHeader.getData_page_header();</span><br><span class="line"><span class="keyword">int</span> numValues = dataPageHeader.getNum_values();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ColumnChunkPageReader <span class="title">readAllPages</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  List&lt;DataPage&gt; pagesInChunk = <span class="keyword">new</span> ArrayList&lt;DataPage&gt;();</span><br><span class="line">  DictionaryPage dictionaryPage = <span class="keyword">null</span>;</span><br><span class="line">  PrimitiveType type = getFileMetaData().getSchema()</span><br><span class="line">      .getType(descriptor.col.getPath()).asPrimitiveType();</span><br><span class="line">  <span class="keyword">long</span> valuesCountReadSoFar = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> dataPageCountReadSoFar = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (hasMorePages(valuesCountReadSoFar, dataPageCountReadSoFar)) &#123;</span><br><span class="line">    PageHeader pageHeader = readPageHeader();</span><br><span class="line">    <span class="keyword">int</span> uncompressedPageSize = pageHeader.getUncompressed_page_size();</span><br><span class="line">    <span class="keyword">int</span> compressedPageSize = pageHeader.getCompressed_page_size();</span><br><span class="line">    <span class="keyword">switch</span> (pageHeader.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> DICTIONARY_PAGE:</span><br><span class="line">        <span class="comment">// there is only one dictionary page per column chunk</span></span><br><span class="line">        <span class="keyword">if</span> (dictionaryPage != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ParquetDecodingException(<span class="string">&quot;more than one dictionary page in column &quot;</span> + descriptor.col);</span><br><span class="line">        &#125;</span><br><span class="line">        DictionaryPageHeader dicHeader = pageHeader.getDictionary_page_header();</span><br><span class="line">        dictionaryPage =</span><br><span class="line">            <span class="keyword">new</span> DictionaryPage(</span><br><span class="line">                <span class="keyword">this</span>.readAsBytesInput(compressedPageSize),</span><br><span class="line">                uncompressedPageSize,</span><br><span class="line">                dicHeader.getNum_values(),</span><br><span class="line">                converter.getEncoding(dicHeader.getEncoding())</span><br><span class="line">                );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DATA_PAGE:</span><br><span class="line">        DataPageHeader dataHeaderV1 = pageHeader.getData_page_header();</span><br><span class="line">        pagesInChunk.add(</span><br><span class="line">            <span class="keyword">new</span> DataPageV1(</span><br><span class="line">                <span class="keyword">this</span>.readAsBytesInput(compressedPageSize),</span><br><span class="line">                dataHeaderV1.getNum_values(),</span><br><span class="line">                uncompressedPageSize,</span><br><span class="line">                converter.fromParquetStatistics(</span><br><span class="line">                    getFileMetaData().getCreatedBy(),</span><br><span class="line">                    dataHeaderV1.getStatistics(),</span><br><span class="line">                    type),</span><br><span class="line">                converter.getEncoding(dataHeaderV1.getRepetition_level_encoding()),</span><br><span class="line">                converter.getEncoding(dataHeaderV1.getDefinition_level_encoding()),</span><br><span class="line">                converter.getEncoding(dataHeaderV1.getEncoding())</span><br><span class="line">                ));</span><br><span class="line">        valuesCountReadSoFar += dataHeaderV1.getNum_values();</span><br><span class="line">        ++dataPageCountReadSoFar;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DATA_PAGE_V2:</span><br><span class="line">        DataPageHeaderV2 dataHeaderV2 = pageHeader.getData_page_header_v2();</span><br><span class="line">        <span class="keyword">int</span> dataSize = compressedPageSize - dataHeaderV2.getRepetition_levels_byte_length() - dataHeaderV2.getDefinition_levels_byte_length();</span><br><span class="line">        pagesInChunk.add(</span><br><span class="line">            <span class="keyword">new</span> DataPageV2(</span><br><span class="line">                dataHeaderV2.getNum_rows(),</span><br><span class="line">                dataHeaderV2.getNum_nulls(),</span><br><span class="line">                dataHeaderV2.getNum_values(),</span><br><span class="line">                <span class="keyword">this</span>.readAsBytesInput(dataHeaderV2.getRepetition_levels_byte_length()),</span><br><span class="line">                <span class="keyword">this</span>.readAsBytesInput(dataHeaderV2.getDefinition_levels_byte_length()),</span><br><span class="line">                converter.getEncoding(dataHeaderV2.getEncoding()),</span><br><span class="line">                <span class="keyword">this</span>.readAsBytesInput(dataSize),</span><br><span class="line">                uncompressedPageSize,</span><br><span class="line">                converter.fromParquetStatistics(</span><br><span class="line">                    getFileMetaData().getCreatedBy(),</span><br><span class="line">                    dataHeaderV2.getStatistics(),</span><br><span class="line">                    type),</span><br><span class="line">                dataHeaderV2.isIs_compressed()</span><br><span class="line">                ));</span><br><span class="line">        valuesCountReadSoFar += dataHeaderV2.getNum_values();</span><br><span class="line">        ++dataPageCountReadSoFar;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        LOG.debug(<span class="string">&quot;skipping page of type &#123;&#125; of size &#123;&#125;&quot;</span>, pageHeader.getType(), compressedPageSize);</span><br><span class="line">        stream.skipFully(compressedPageSize);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (offsetIndex == <span class="keyword">null</span> &amp;&amp; valuesCountReadSoFar != descriptor.metadata.getValueCount()) &#123;</span><br><span class="line">    <span class="comment">// Would be nice to have a CorruptParquetFileException or something as a subclass?</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">        <span class="string">&quot;Expected &quot;</span> + descriptor.metadata.getValueCount() + <span class="string">&quot; values in column chunk at &quot;</span> +</span><br><span class="line">        getPath() + <span class="string">&quot; offset &quot;</span> + descriptor.metadata.getFirstDataPageOffset() +</span><br><span class="line">        <span class="string">&quot; but got &quot;</span> + valuesCountReadSoFar + <span class="string">&quot; values instead over &quot;</span> + pagesInChunk.size()</span><br><span class="line">        + <span class="string">&quot; pages ending at file offset &quot;</span> + (descriptor.fileOffset + stream.position()));</span><br><span class="line">  &#125;</span><br><span class="line">  BytesInputDecompressor decompressor = options.getCodecFactory().getDecompressor(descriptor.metadata.getCodec());</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ColumnChunkPageReader(decompressor, pagesInChunk, dictionaryPage, offsetIndex,</span><br><span class="line">      blocks.get(currentBlock).getRowCount());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<hr>
<hr>
<h1 id="读"><a href="#读" class="headerlink" title="读"></a>读</h1><h2 id="原生-parquet"><a href="#原生-parquet" class="headerlink" title="原生 parquet"></a>原生 parquet</h2><p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528104542.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528104910.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105205.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105231.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105342.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528105441.png"></p>
<hr>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103634.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103701.png"></p>
<p>ColumnChunkPageReadStore(RowGroupImpl)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">public <span class="type">DataPage</span> readPage() &#123;</span><br><span class="line">  <span class="keyword">if</span> (compressedPages.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">DataPage</span> compressedPage = compressedPages.remove(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">final</span> int currentPageIndex = pageIndex++;</span><br><span class="line">  <span class="keyword">return</span> compressedPage.accept(<span class="keyword">new</span> <span class="type">DataPage</span>.<span class="type">Visitor</span>&lt;<span class="type">DataPage</span>&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">DataPage</span> visit(<span class="type">DataPageV1</span> dataPageV1) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">BytesInput</span> decompressed = decompressor.decompress(dataPageV1.getBytes(), dataPageV1.getUncompressedSize());</span><br><span class="line">        <span class="keyword">if</span> (offsetIndex == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">DataPageV1</span>(</span><br><span class="line">              decompressed,</span><br><span class="line">              dataPageV1.getValueCount(),</span><br><span class="line">              dataPageV1.getUncompressedSize(),</span><br><span class="line">              dataPageV1.getStatistics(),</span><br><span class="line">              dataPageV1.getRlEncoding(),</span><br><span class="line">              dataPageV1.getDlEncoding(),</span><br><span class="line">              dataPageV1.getValueEncoding());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          long firstRowIndex = offsetIndex.getFirstRowIndex(currentPageIndex);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">DataPageV1</span>(</span><br><span class="line">              decompressed,</span><br><span class="line">              dataPageV1.getValueCount(),</span><br><span class="line">              dataPageV1.getUncompressedSize(),</span><br><span class="line">              firstRowIndex,</span><br><span class="line">              <span class="type">Math</span>.toIntExact(offsetIndex.getLastRowIndex(currentPageIndex, rowCount) - firstRowIndex + <span class="number">1</span>),</span><br><span class="line">              dataPageV1.getStatistics(),</span><br><span class="line">              dataPageV1.getRlEncoding(),</span><br><span class="line">              dataPageV1.getDlEncoding(),</span><br><span class="line">              dataPageV1.getValueEncoding());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ParquetDecodingException</span>(<span class="string">&quot;could not decompress page&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">DataPage</span> visit(<span class="type">DataPageV2</span> dataPageV2) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!dataPageV2.isCompressed()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (offsetIndex == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> dataPageV2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="type">DataPageV2</span>.uncompressed(</span><br><span class="line">              dataPageV2.getRowCount(),</span><br><span class="line">              dataPageV2.getNullCount(),</span><br><span class="line">              dataPageV2.getValueCount(),</span><br><span class="line">              offsetIndex.getFirstRowIndex(currentPageIndex),</span><br><span class="line">              dataPageV2.getRepetitionLevels(),</span><br><span class="line">              dataPageV2.getDefinitionLevels(),</span><br><span class="line">              dataPageV2.getDataEncoding(),</span><br><span class="line">              dataPageV2.getData(),</span><br><span class="line">              dataPageV2.getStatistics());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        int uncompressedSize = <span class="type">Math</span>.toIntExact(</span><br><span class="line">            dataPageV2.getUncompressedSize()</span><br><span class="line">                - dataPageV2.getDefinitionLevels().size()</span><br><span class="line">                - dataPageV2.getRepetitionLevels().size());</span><br><span class="line">        <span class="type">BytesInput</span> decompressed = decompressor.decompress(dataPageV2.getData(), uncompressedSize);</span><br><span class="line">        <span class="keyword">if</span> (offsetIndex == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="type">DataPageV2</span>.uncompressed(</span><br><span class="line">              dataPageV2.getRowCount(),</span><br><span class="line">              dataPageV2.getNullCount(),</span><br><span class="line">              dataPageV2.getValueCount(),</span><br><span class="line">              dataPageV2.getRepetitionLevels(),</span><br><span class="line">              dataPageV2.getDefinitionLevels(),</span><br><span class="line">              dataPageV2.getDataEncoding(),</span><br><span class="line">              decompressed,</span><br><span class="line">              dataPageV2.getStatistics());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="type">DataPageV2</span>.uncompressed(</span><br><span class="line">              dataPageV2.getRowCount(),</span><br><span class="line">              dataPageV2.getNullCount(),</span><br><span class="line">              dataPageV2.getValueCount(),</span><br><span class="line">              offsetIndex.getFirstRowIndex(currentPageIndex),</span><br><span class="line">              dataPageV2.getRepetitionLevels(),</span><br><span class="line">              dataPageV2.getDefinitionLevels(),</span><br><span class="line">              dataPageV2.getDataEncoding(),</span><br><span class="line">              decompressed,</span><br><span class="line">              dataPageV2.getStatistics());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ParquetDecodingException</span>(<span class="string">&quot;could not decompress page&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="spark"><a href="#spark" class="headerlink" title="spark"></a>spark</h2><p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528110659.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528110909.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528111155.png"></p>
<p><strong>spark 读的调用栈</strong><br><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103907.png"></p>
<p><strong>Vectorized read</strong><br><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528103951.png"></p>
<p><img src="/2019/05/09/Parquet-%E4%B9%B1%E5%BC%B9/20190528104202.png"></p>
<h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads `total` values from this columnReader into column.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">void readBatch(int total, <span class="type">WritableColumnVector</span> column) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  int rowId = <span class="number">0</span>;</span><br><span class="line">  <span class="type">WritableColumnVector</span> dictionaryIds = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (dictionary != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// SPARK-16334: We only maintain a single dictionary per row batch, so that it can be used to</span></span><br><span class="line">    <span class="comment">// decode all previous dictionary encoded pages if we ever encounter a non-dictionary encoded</span></span><br><span class="line">    <span class="comment">// page.</span></span><br><span class="line">    dictionaryIds = column.reserveDictionaryIds(total);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (total &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Compute the number of values we want to read in this page.</span></span><br><span class="line">    int leftInPage = (int) (endOfPageValueCount - valuesRead);</span><br><span class="line">    <span class="keyword">if</span> (leftInPage == <span class="number">0</span>) &#123;</span><br><span class="line">      readPage();</span><br><span class="line">      leftInPage = (int) (endOfPageValueCount - valuesRead);</span><br><span class="line">    &#125;</span><br><span class="line">    int num = <span class="type">Math</span>.min(total, leftInPage);</span><br><span class="line">    <span class="type">PrimitiveType</span>.<span class="type">PrimitiveTypeName</span> typeName =</span><br><span class="line">      descriptor.getPrimitiveType().getPrimitiveTypeName();</span><br><span class="line">    <span class="keyword">if</span> (isCurrentPageDictionaryEncoded) &#123;</span><br><span class="line">      <span class="comment">// Read and decode dictionary ids.</span></span><br><span class="line">      defColumn.readIntegers(</span><br><span class="line">          num, dictionaryIds, column, rowId, maxDefLevel, (<span class="type">VectorizedValuesReader</span>) dataColumn);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TIMESTAMP_MILLIS encoded as INT64 can&#x27;t be lazily decoded as we need to post process</span></span><br><span class="line">      <span class="comment">// the values to add microseconds precision.</span></span><br><span class="line">      <span class="keyword">if</span> (column.hasDictionary() || (rowId == <span class="number">0</span> &amp;&amp;</span><br><span class="line">          (typeName == <span class="type">PrimitiveType</span>.<span class="type">PrimitiveTypeName</span>.<span class="type">INT32</span> ||</span><br><span class="line">          (typeName == <span class="type">PrimitiveType</span>.<span class="type">PrimitiveTypeName</span>.<span class="type">INT64</span> &amp;&amp;</span><br><span class="line">            originalType != <span class="type">OriginalType</span>.<span class="type">TIMESTAMP_MILLIS</span>) ||</span><br><span class="line">          typeName == <span class="type">PrimitiveType</span>.<span class="type">PrimitiveTypeName</span>.<span class="type">FLOAT</span> ||</span><br><span class="line">          typeName == <span class="type">PrimitiveType</span>.<span class="type">PrimitiveTypeName</span>.<span class="type">DOUBLE</span> ||</span><br><span class="line">          typeName == <span class="type">PrimitiveType</span>.<span class="type">PrimitiveTypeName</span>.<span class="type">BINARY</span>))) &#123;</span><br><span class="line">        <span class="comment">// Column vector supports lazy decoding of dictionary values so just set the dictionary.</span></span><br><span class="line">        <span class="comment">// We can&#x27;t do this if rowId != 0 AND the column doesn&#x27;t have a dictionary (i.e. some</span></span><br><span class="line">        <span class="comment">// non-dictionary encoded values have already been added).</span></span><br><span class="line">        column.setDictionary(<span class="keyword">new</span> <span class="type">ParquetDictionary</span>(dictionary));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        decodeDictionaryIds(rowId, num, column, dictionaryIds);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (column.hasDictionary() &amp;&amp; rowId != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This batch already has dictionary encoded values but this new page is not. The batch</span></span><br><span class="line">        <span class="comment">// does not support a mix of dictionary and not so we will decode the dictionary.</span></span><br><span class="line">        decodeDictionaryIds(<span class="number">0</span>, rowId, column, column.getDictionaryIds());</span><br><span class="line">      &#125;</span><br><span class="line">      column.setDictionary(<span class="literal">null</span>);</span><br><span class="line">      switch (typeName) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">BOOLEAN</span>:</span><br><span class="line">          readBooleanBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">INT32</span>:</span><br><span class="line">          readIntBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">INT64</span>:</span><br><span class="line">          readLongBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">INT96</span>:</span><br><span class="line">          readBinaryBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">FLOAT</span>:</span><br><span class="line">          readFloatBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">DOUBLE</span>:</span><br><span class="line">          readDoubleBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">BINARY</span>:</span><br><span class="line">          readBinaryBatch(rowId, num, column);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">FIXED_LEN_BYTE_ARRAY</span>:</span><br><span class="line">          readFixedLenByteArrayBatch(</span><br><span class="line">            rowId, num, column, descriptor.getPrimitiveType().getTypeLength());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">&quot;Unsupported type: &quot;</span> + typeName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    valuesRead += num;</span><br><span class="line">    rowId += num;</span><br><span class="line">    total -= num;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><!-- flag of hidden posts -->
    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Parquet/" rel="tag"><i class="fa fa-tag"></i> Parquet</a>
          </div>

        


        
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#page"><span class="nav-number">1.</span> <span class="nav-text">page</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%BB"><span class="nav-number"></span> <span class="nav-text">读</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F-parquet"><span class="nav-number"></span> <span class="nav-text">原生 parquet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spark"><span class="nav-number"></span> <span class="nav-text">spark</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#code"><span class="nav-number"></span> <span class="nav-text">code</span></a></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jiatao Tao"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">Jiatao Tao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/aaaaaaron" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;aaaaaaron" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:tao@apache.org" title="E-Mail → mailto:tao@apache.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiatao Tao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a>
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
